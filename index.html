<html>
<head>
    <title>Main Page</title>
</head>
<body name="mainpage">
<h2>Index Page</h2>
<button onclick="openPopUp()"> Popup child</button>
<script>

  const CHILD_WINDOW_URL    = 'child.html';
  const CHILD_WINDOW_NAME   = 'childWindow';
  const scriptFile = 'dynamicScript.js';

  function openPopUp(){
    var newWindow = window.open(CHILD_WINDOW_URL, CHILD_WINDOW_NAME);
    addScriptDynamicallyToPopup(newWindow);
  }

  function appendScriptToBody(windowToAttach, file) {
    var body  = windowToAttach.document.body;
    var script  = windowToAttach.document.createElement('script');
    script.async = true;
    script.src = file;
    body.appendChild(script);
  }

  function addScriptDynamicallyToPopup(popUpWindow, isReloaded) {

    function reAttachAfterReload(){
      addScriptDynamicallyToPopup(popUpWindow, true);
    }

    // fired when user refreshes the page
    popUpWindow.addEventListener('beforeunload', function (e) {
      // in current execution context, page reload happens, so delay the attachment to next execution context
      setTimeout(reAttachAfterReload,0)
    });

    if(isReloaded){
      appendScriptToBody(popUpWindow, scriptFile);
    } else {
      popUpWindow.addEventListener('DOMContentLoaded', function (e){
        appendScriptToBody(popUpWindow, scriptFile);
      });
    }


  }
</script>
</body>
</html>
